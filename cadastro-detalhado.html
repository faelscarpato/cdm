<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro Detalhado de Máquinas e Moldes - CDM-MB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --sidebar-width: 250px; --sidebar-width-collapsed: 80px; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .main-content { transition: margin-left 0.3s ease; margin-left: var(--sidebar-width-collapsed); }
        .sidebar { width: var(--sidebar-width); transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .long-title { display: none; }
        @media (max-width: 768px) {
            .main-content { margin-left: 0; }
            .sidebar { transform: translateX(-100%); width: var(--sidebar-width); }
            .sidebar.show { transform: translateX(0); }
            .sidebar.show .nav-text, .sidebar.show .long-title { display: inline; }
            .sidebar.collapsed { width: var(--sidebar-width); }
        }

        /* Botões e Inputs */
        .action-button { padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .form-input, .form-select, .form-textarea { padding: 0.6rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; box-sizing: border-box; font-size: 0.875rem; width: 100%; background-color: white; }
        .btn-primary { background-color: #4f46e5; color: white; } .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; } .btn-secondary:hover { background-color: #4b5563; }
        .btn-green { background-color: #10b981; color: white; } .btn-green:hover { background-color: #059669; }
        .btn-red { background-color: #ef4444; color: white; } .btn-red:hover { background-color: #dc2626; }
        .btn-blue { background-color: #3b82f6; color: white; } .btn-blue:hover { background-color: #2563eb; }

        /* Modals e Alertas */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 90%; max-width: 700px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .modal-close-button { background: none; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; color: #9ca3af; } .modal-close-button:hover{color: #4b5563;}

        /* Loading Spinner */
        #loadingOverlay { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; }
        #loadingSpinner { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .record-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .record-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #e5e7eb;
        }

        .record-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #3b82f6; /* Blue for machine names */
            margin-bottom: 0.5rem;
        }

        .record-card p {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .record-card .actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }
        .record-card .actions button {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }
        .record-card .actions .edit-button { background-color: #f59e0b; color: white; }
        .record-card .actions .edit-button:hover { background-color: #d97706; }
        .record-card .actions .delete-button { background-color: #ef4444; color: white; }
        .record-card .actions .delete-button:hover { background-color: #dc2626; }
    </style>
</head>
<body class="bg-gray-200">
    <div id="loadingOverlay"><div id="loadingSpinner"></div></div>
    <div id="alertContainer" class="fixed top-20 left-1/2 -translate-x-1/2 z-[1060] w-max max-w-[90%]"></div>

       <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-white h-screen fixed top-0 left-0 z-40 flex flex-col collapsed">
        <div class="p-4 flex items-center justify-between h-16 border-b border-gray-700">
            <h1 class="text-2xl font-bold whitespace-nowrap overflow-hidden">
                <span class="long-title">CDM - MB</span>
            </h1>
            <button id="close-sidebar" class="text-gray-400 hover:text-white md:hidden text-3xl leading-none">&times;</button>
        </div>
        <nav class="flex-grow p-2 overflow-y-auto">
            <ul>
                <li>
                    <a href="index.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Página Inicial">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-7-7v10a1 1 0 01-1 1H6a1 1 0 01-1-1v-10"></path></svg>
                        <span class="ml-4 nav-text">Página Inicial</span>
                    </a>
                </li>
                <li>
                    <a href="absenteismo.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Absenteísmo">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.225-1.26-.623-1.741M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 0c-2.21 0-4 2.24-4 5v2h8v-2c0-2.76-1.79-5-4-5z"></path></svg>
                        <span class="ml-4 nav-text">Absenteísmo</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="status_t1.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 1ºT</span>
                    </a>
                </li>
                 <li>
                    <a href="status.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 2ºT</span>
                    </a>
                </li>
                 <li>
                    <a href="status_t3.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 3ºT</span>
                    </a>
                </li>
                <li>
                    <a href="cadastro-detalhado.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Cadastro Máquinas/Moldes">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8H4a2 2 0 01-2-2v-4A2 2 0 014 12h2m-2 4h4m5-4h5a2 2 0 012 2v4a2 2 0 01-2 2h-5m-2-4H9m2 2h2"></path></svg>
                        <span class="ml-4 nav-text">Cadastro Detalhado</span>
                    </a>
                </li>
                <li>
                    <a href="analise_causa_raiz.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Análise de Causa Raiz">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span class="ml-4 nav-text">Análise de Causa Raiz</span>
                    </a>
                </li>
                <li>
                    <a href="ordens_servico.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Ordens de Serviço">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="ml-4 nav-text">Ordens de Serviço</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_qualidade.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Qualidade">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Qualidade</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard_qualidade.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard de Qualidade">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard de Qualidade</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_manutencao.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Manutenção">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Manutenção</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_estoque.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Estoque">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Estoque</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard_geral_consolidado.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard Geral Consolidado">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v8m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard Geral</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-2 border-t border-gray-700">
            <a href="#" id="settings-button" class="flex items-center p-3 rounded-lg hover:bg-gray-700" title="Configurações">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="ml-4 nav-text">Configurações</span>
            </a>
        </div>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <div class="main-content">
        <header class="bg-white shadow-md sticky top-0 z-20 h-16 flex items-center px-6">
            <button id="menu-button" class="p-2 text-gray-500 rounded-md -ml-2 mr-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-semibold text-gray-800">
                <span class="hidden sm:inline">Ciclos Diários de Máquinas - MB</span>
                <span class="sm:hidden">CDM - MB</span>
            </h1>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">CADASTRO DETALHADO</h1>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <nav class="flex justify-center gap-4 mb-6">
                    <button id="navMachine" class="action-button btn-primary">
                        <i data-lucide="cog" class="mr-2 w-5 h-5"></i> Cadastrar Máquina
                    </button>
                    <button id="navMold" class="action-button btn-secondary">
                        <i data-lucide="box" class="mr-2 w-5 h-5"></i> Cadastrar Molde
                    </button>
                </nav>

                <section id="machine-section">
                    <div class="section-header">
                        <i data-lucide="settings" class="w-7 h-7 text-blue-600"></i>
                        <h2>Cadastro de Máquinas</h2>
                    </div>
                    <form id="machine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="machineId" />
                        <div>
                            <label for="machineBrand" class="block text-sm font-medium text-gray-700 mb-1">Marca</label>
                            <input type="text" id="machineBrand" class="form-input" placeholder="Ex: BMB" required />
                        </div>
                        <div>
                            <label for="machineModel" class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                            <input type="text" id="machineModel" class="form-input" placeholder="Ex: KW500/3450" required />
                        </div>
                        <div>
                            <label for="machineYear" class="block text-sm font-medium text-gray-700 mb-1">Ano de Fabricação</label>
                            <input type="number" id="machineYear" class="form-input" placeholder="Ex: 2001" min="1900" max="2100" required />
                        </div>
                        <div>
                            <label for="machineClosingForce" class="block text-sm font-medium text-gray-700 mb-1">Fechamento (ton)</label>
                            <input type="number" step="0.1" id="machineClosingForce" class="form-input" placeholder="Ex: 500" required />
                        </div>
                        <div>
                            <label for="machineInjectionVolume" class="block text-sm font-medium text-gray-700 mb-1">Volume de Injeção (cm³)</label>
                            <input type="number" step="0.1" id="machineInjectionVolume" class="form-input" placeholder="Ex: 1960" required />
                        </div>
                        <div>
                            <label for="machineBetweenColumns" class="block text-sm font-medium text-gray-700 mb-1">Entre Colunas (mm)</label>
                            <input type="text" id="machineBetweenColumns" class="form-input" placeholder="Ex: 810x710" required />
                        </div>
                        <div class="md:col-span-2">
                            <label for="machineHydraulicSystem" class="block text-sm font-medium text-gray-700 mb-1">Sistema Hidráulico</label>
                            <input type="text" id="machineHydraulicSystem" class="form-input" placeholder="Ex: com acumulador" />
                        </div>
                        <div>
                            <label for="machineMotorPower" class="block text-sm font-medium text-gray-700 mb-1">Potência do Motor (kW)</label>
                            <input type="number" step="0.1" id="machineMotorPower" class="form-input" placeholder="Ex: 75" />
                        </div>
                        <div>
                            <label for="machineHeatingPower" class="block text-sm font-medium text-gray-700 mb-1">Potência de Aquecimento (kW)</label>
                            <input type="number" step="0.1" id="machineHeatingPower" class="form-input" placeholder="Ex: 40" />
                        </div>
                        <div>
                            <label for="machineInjectionVolumePerSecond" class="block text-sm font-medium text-gray-700 mb-1">Volume Injeção/seg (cm³)</label>
                            <input type="number" step="0.1" id="machineInjectionVolumePerSecond" class="form-input" placeholder="Ex: 2900" />
                        </div>
                        <div>
                            <label for="machineMoldMinHeight" class="block text-sm font-medium text-gray-700 mb-1">Altura Mín. Molde (mm)</label>
                            <input type="number" step="0.1" id="machineMoldMinHeight" class="form-input" placeholder="Ex: 250" />
                        </div>
                        <div>
                            <label for="machineMoldMaxHeight" class="block text-sm font-medium text-gray-700 mb-1">Altura Máx. Molde (mm)</label>
                            <input type="number" step="0.1" id="machineMoldMaxHeight" class="form-input" placeholder="Ex: 800" />
                        </div>
                        <div class="md:col-span-2 flex justify-center gap-3 mt-4">
                            <button type="submit" class="action-button btn-primary w-full md:w-auto">
                                <i data-lucide="save" class="mr-2 w-5 h-5"></i> Salvar Máquina
                            </button>
                            <button type="button" id="cancelMachineEdit" class="action-button btn-secondary w-full md:w-auto hidden">
                                <i data-lucide="x-circle" class="mr-2 w-5 h-5"></i> Cancelar Edição
                            </button>
                        </div>
                    </form>
                </section>

                <section id="mold-section" class="hidden mt-8">
                    <div class="section-header">
                        <i data-lucide="package" class="w-7 h-7 text-green-600"></i>
                        <h2>Cadastro de Moldes</h2>
                    </div>
                    <form id="mold-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="moldId" />
                        <div>
                            <label for="moldModel" class="block text-sm font-medium text-gray-700 mb-1">Modelo do Molde</label>
                            <input type="text" id="moldModel" class="form-input" placeholder="Ex: M-12345" required />
                        </div>
                        <div>
                            <label for="moldProductionPart" class="block text-sm font-medium text-gray-700 mb-1">Peça de Produção</label>
                            <input type="text" id="moldProductionPart" class="form-input" placeholder="Ex: Tampa X" required />
                        </div>
                        <div>
                            <label for="moldYear" class="block text-sm font-medium text-gray-700 mb-1">Ano do Molde</label>
                            <input type="number" id="moldYear" class="form-input" placeholder="Ex: 2010" min="1900" max="2100" required />
                        </div>
                        <div class="md:col-span-2">
                            <label for="moldDetails" class="block text-sm font-medium text-gray-700 mb-1">Detalhes Atuais (Desgaste, Oxidação, etc.)</label>
                            <textarea id="moldDetails" rows="4" class="form-textarea" placeholder="Descreva o estado atual do molde: desgaste, oxidação, reparos..."></textarea>
                        </div>
                        <div class="md:col-span-2 flex justify-center gap-3 mt-4">
                            <button type="submit" class="action-button btn-green w-full md:w-auto">
                                <i data-lucide="save" class="mr-2 w-5 h-5"></i> Salvar Molde
                            </button>
                            <button type="button" id="cancelMoldEdit" class="action-button btn-secondary w-full md:w-auto hidden">
                                <i data-lucide="x-circle" class="mr-2 w-5 h-5"></i> Cancelar Edição
                            </button>
                        </div>
                    </form>
                </section>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="section-header">
                    <i data-lucide="factory" class="w-7 h-7 text-blue-600"></i>
                    <h2>Máquinas Cadastradas</h2>
                </div>
                <div id="machine-list" class="record-list">
                    <p class="text-gray-500 text-center col-span-full">Nenhuma máquina cadastrada ainda.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="section-header">
                    <i data-lucide="cube" class="w-7 h-7 text-green-600"></i>
                    <h2>Moldes Cadastrados</h2>
                </div>
                <div id="mold-list" class="record-list">
                    <p class="text-gray-500 text-center col-span-full">Nenhum molde cadastrado ainda.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-settings" class="modal-overlay"><div class="modal-content max-w-lg"><div class="modal-header"><h2 class="modal-title">Configurações</h2><button class="modal-close-button" data-close-modal-id="modal-settings">&times;</button></div><div><label for="gemini-api-key" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave API Google Gemini</label><input type="password" id="gemini-api-key" class="w-full p-2 border rounded-md mb-2" placeholder="Cole sua chave aqui"><button id="save-api-key" class="action-button btn-primary w-full mb-4">Salvar Chave</button><div class="text-center"><button id="show-tutorial" class="text-indigo-600 hover:underline text-sm">Como Obter Chave API?</button></div></div></div></div>
    <div id="modal-tutorial" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">Como Obter sua Chave API do Google Gemini</h2><button class="modal-close-button" data-close-modal-id="modal-tutorial">&times;</button></div><div class="prose max-w-none text-gray-700"><p>Para utilizar todas as funcionalidades de análise por IA, você precisará de uma Chave API do Google Gemini. O Gemini 1.5 Flash, que é necessária, oferece um nível gratuito generoso.</p><h4>Passo 1: Acesse o Google AI Studio</h4><p>Se você ainda não tem uma conta Google, precisará criar uma. Depois, acesse o Google AI Studio:</p><a href="https://aistudio.google.com/app/apikey" target="_blank" class="action-button btn-primary">Ir para o Google AI Studio &rarr;</a><h4 class="mt-4">Passo 2: Gere sua Chave API</h4><ul><li>Procure pela opção "Get API key" ou "Criar chave API".</li><li>Clique em "Create API key in new project".</li><li>Siga as instruções para nomear seu projeto, se necessário.</li><li>Após a criação, sua chave API será exibida.</li></ul><h4>Passo 3: Copie e Cole sua Chave API</h4><ul><li>Clique no botão para copiar sua chave API.</li><li>Volte para esta página (dentro do modal de Configurações).</li><li>Cole a chave no campo "Sua Chave API Google Gemini".</li><li>Clique em "Salvar".</li></ul><p class="font-semibold mt-4">Importante: Guarde sua chave API em um local seguro e não a compartilhe publicamente.</p></div><div class="mt-6 text-center"><button class="action-button btn-secondary" data-close-modal-id="modal-tutorial">Entendi - Fechar Tutorial</button></div></div></div>

    <script>
        // --- SUPABASE CLIENT ---
        // Ensure this matches the URL and Key used in other JS files if they share a Supabase project.
        // I'm using placeholder values, replace with actual Supabase project URL and Anon Key.
        const SUPABASE_URL = 'https://ranhhacbgyfpzrjdynnd.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhbmhoYWNiZ3lmcHpyamR5bm5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5MDU4OTEsImV4cCI6MjA1OTQ4MTg5MX0.Ey-X4Tz8krKHSICnYdHdBaI3q5WcRgUVwA8jOhfMr7Y';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        

        // --- GLOBAL VARIABLES ---
        let machines = [];
        let molds = [];

        // --- DOM REFERENCES ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const alertContainer = document.getElementById('alertContainer');

        const navMachineBtn = document.getElementById('navMachine');
        const navMoldBtn = document.getElementById('navMold');
        const machineSection = document.getElementById('machine-section');
        const moldSection = document.getElementById('mold-section');

        const machineForm = document.getElementById('machine-form');
        const machineIdInput = document.getElementById('machineId');
        const machineBrandInput = document.getElementById('machineBrand');
        const machineModelInput = document.getElementById('machineModel');
        const machineYearInput = document.getElementById('machineYear');
        const machineClosingForceInput = document.getElementById('machineClosingForce');
        const machineInjectionVolumeInput = document.getElementById('machineInjectionVolume');
        const machineBetweenColumnsInput = document.getElementById('machineBetweenColumns');
        const machineHydraulicSystemInput = document.getElementById('machineHydraulicSystem');
        const machineMotorPowerInput = document.getElementById('machineMotorPower');
        const machineHeatingPowerInput = document.getElementById('machineHeatingPower');
        const machineInjectionVolumePerSecondInput = document.getElementById('machineInjectionVolumePerSecond');
        const machineMoldMinHeightInput = document.getElementById('machineMoldMinHeight');
        const machineMoldMaxHeightInput = document.getElementById('machineMoldMaxHeight');
        const saveMachineBtn = machineForm.querySelector('button[type="submit"]');
        const cancelMachineEditBtn = document.getElementById('cancelMachineEdit');
        const machineListDiv = document.getElementById('machine-list');

        const moldForm = document.getElementById('mold-form');
        const moldIdInput = document.getElementById('moldId');
        const moldModelInput = document.getElementById('moldModel');
        const moldProductionPartInput = document.getElementById('moldProductionPart');
        const moldYearInput = document.getElementById('moldYear');
        const moldDetailsInput = document.getElementById('moldDetails');
        const saveMoldBtn = moldForm.querySelector('button[type="submit"]');
        const cancelMoldEditBtn = document.getElementById('cancelMoldEdit');
        const moldListDiv = document.getElementById('mold-list');

        // --- UTILITY FUNCTIONS ---
        const showLoading = (isLoading) => { loadingOverlay.style.display = isLoading ? 'flex' : 'none'; };
        function showCustomAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert ${type === 'error' ? 'custom-alert-error' : 'custom-alert-success'}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button class="custom-alert-close-button ${type === 'error' ? 'custom-alert-close-button-error' : 'custom-alert-close-button-success'}" onclick="this.parentElement.remove()">
                    &times;
                </button>
            `;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => { alertDiv.remove(); }, 5000); // Remove after 5 seconds
        }

        // --- NAVIGATION & LAYOUT (Sidebar copied from absenteismo.html) ---
        function setupModal(modalId, openTriggerId) {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(openTriggerId);
            if (modal && openBtn) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modal.classList.add('show');
                });
            }
        }

        function setupAppLayout() {
            setupModal('modal-settings', 'settings-button');
            setupModal('modal-tutorial', 'show-tutorial');

            const sidebar = document.getElementById('sidebar');
            const menuButton = document.getElementById('menu-button');
            const closeSidebarButton = document.getElementById('close-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            menuButton.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.add('show');
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    sidebar.classList.toggle('collapsed');
                    document.querySelector('.main-content').style.marginLeft = sidebar.classList.contains('collapsed') ? 'var(--sidebar-width-collapsed)' : 'var(--sidebar-width)';
                }
            });
            closeSidebarButton.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.add('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.add('hidden');
            });

            document.body.addEventListener('click', (e) => {
                if (e.target.dataset.closeModalId) {
                    document.getElementById(e.target.dataset.closeModalId).classList.remove('show');
                }
            });
            
            const apiKeyInput = document.getElementById('gemini-api-key');
            const saveApiKeyBtn = document.getElementById('save-api-key');
            if (apiKeyInput) apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    showCustomAlert('Chave API salva com sucesso!', 'success');
                    document.getElementById('modal-settings').classList.remove('show');
                } else {
                    showCustomAlert('Por favor, insira uma chave API válida.', 'error');
                }
            });
        }

        // --- FORM LOGIC: MACHINES ---
        async function saveMachine(event) {
            event.preventDefault();
            showLoading(true);

            const id = machineIdInput.value;
            const machineData = {
                marca: machineBrandInput.value.trim(),
                modelo: machineModelInput.value.trim(),
                ano_fabricacao: parseInt(machineYearInput.value),
                fechamento_ton: parseFloat(machineClosingForceInput.value),
                volume_injecao_cm3: parseFloat(machineInjectionVolumeInput.value),
                entre_colunas_mm: machineBetweenColumnsInput.value.trim(),
                sistema_hidraulico: machineHydraulicSystemInput.value.trim() || null,
                potencia_motor_kw: parseFloat(machineMotorPowerInput.value) || null,
                potencia_aquecimento_kw: parseFloat(machineHeatingPowerInput.value) || null,
                volume_injecao_seg_cm3: parseFloat(machineInjectionVolumePerSecondInput.value) || null,
                altura_min_molde_mm: parseFloat(machineMoldMinHeightInput.value) || null,
                altura_max_molde_mm: parseFloat(machineMoldMaxHeightInput.value) || null,
            };

            let error;
            if (id) {
                // Update existing machine
                ({ error } = await sbClient.from('maquinas_detalhes').update(machineData).eq('id', id));
            } else {
                // Insert new machine
                ({ error } = await sbClient.from('maquinas_detalhes').insert([machineData]));
            }

            if (error) {
                console.error("Erro ao salvar máquina:", error);
                showCustomAlert(`Erro ao salvar máquina: ${error.message}`, 'error');
            } else {
                showCustomAlert(`Máquina ${id ? 'atualizada' : 'cadastrada'} com sucesso!`, 'success');
                resetMachineForm();
                await loadMachines();
            }
            showLoading(false);
        }

        function editMachine(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (!machine) return;

            machineIdInput.value = machine.id;
            machineBrandInput.value = machine.marca;
            machineModelInput.value = machine.modelo;
            machineYearInput.value = machine.ano_fabricacao;
            machineClosingForceInput.value = machine.fechamento_ton;
            machineInjectionVolumeInput.value = machine.volume_injecao_cm3;
            machineBetweenColumnsInput.value = machine.entre_colunas_mm;
            machineHydraulicSystemInput.value = machine.sistema_hidraulico || '';
            machineMotorPowerInput.value = machine.potencia_motor_kw || '';
            machineHeatingPowerInput.value = machine.potencia_aquecimento_kw || '';
            machineInjectionVolumePerSecondInput.value = machine.volume_injecao_seg_cm3 || '';
            machineMoldMinHeightInput.value = machine.altura_min_molde_mm || '';
            machineMoldMaxHeightInput.value = machine.altura_max_molde_mm || '';

            saveMachineBtn.textContent = 'Atualizar Máquina';
            saveMachineBtn.querySelector('i').setAttribute('data-lucide', 'save'); // Ensure icon is 'save'
            cancelMachineEditBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top for editing
            lucide.createIcons(); // Re-render lucide icons if changed
        }

        async function deleteMachine(machineId, machineName) {
            if (!confirm(`Tem certeza que deseja excluir a máquina "${machineName}"? Esta ação não pode ser desfeita.`)) {
                return;
            }
            showLoading(true);
            const { error } = await sbClient.from('maquinas_detalhes').delete().eq('id', machineId);
            if (error) {
                console.error("Erro ao excluir máquina:", error);
                showCustomAlert(`Erro ao excluir máquina: ${error.message}`, 'error');
            } else {
                showCustomAlert('Máquina excluída com sucesso!', 'success');
                await loadMachines();
            }
            showLoading(false);
        }

        function resetMachineForm() {
            machineForm.reset();
            machineIdInput.value = '';
            saveMachineBtn.innerHTML = '<i data-lucide="save" class="mr-2 w-5 h-5"></i> Salvar Máquina';
            cancelMachineEditBtn.classList.add('hidden');
            lucide.createIcons(); // Re-render lucide icons if changed
        }

        async function loadMachines() {
            showLoading(true);
            const { data, error } = await sbClient.from('maquinas_detalhes').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error("Erro ao carregar máquinas:", error);
                showCustomAlert(`Erro ao carregar máquinas: ${error.message}`, 'error');
                machineListDiv.innerHTML = '<p class="text-red-500 text-center col-span-full">Erro ao carregar máquinas.</p>';
                machines = [];
            } else {
                machines = data || [];
                renderMachineList();
            }
            showLoading(false);
        }

        function renderMachineList() {
            machineListDiv.innerHTML = '';
            if (machines.length === 0) {
                machineListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Nenhuma máquina cadastrada ainda.</p>';
                return;
            }
            machines.forEach(machine => {
                const card = document.createElement('div');
                card.className = 'record-card';
                card.innerHTML = `
                    <h3>${machine.marca} - ${machine.modelo} (${machine.ano_fabricacao})</h3>
                    <p><strong>Fechamento:</strong> ${machine.fechamento_ton} ton</p>
                    <p><strong>Vol. Injeção:</strong> ${machine.volume_injecao_cm3} cm³ (${(machine.volume_injecao_cm3 * 0.75).toFixed(0)}g)</p>
                    <p><strong>Entre Colunas:</strong> ${machine.entre_colunas_mm}</p>
                    ${machine.sistema_hidraulico ? `<p><strong>Hidráulico:</strong> ${machine.sistema_hidraulico}</p>` : ''}
                    ${machine.potencia_motor_kw ? `<p><strong>Motor:</strong> ${machine.potencia_motor_kw} kW</p>` : ''}
                    ${machine.potencia_aquecimento_kw ? `<p><strong>Aquecimento:</strong> ${machine.potencia_aquecimento_kw} kW</p>` : ''}
                    ${machine.volume_injecao_seg_cm3 ? `<p><strong>Vol. Injeção/seg:</strong> ${machine.volume_injecao_seg_cm3} cm³</p>` : ''}
                    ${machine.altura_min_molde_mm && machine.altura_max_molde_mm ? `<p><strong>Alt. Molde:</strong> ${machine.altura_min_molde_mm}mm a ${machine.altura_max_molde_mm}mm</p>` : ''}
                    <div class="actions">
                        <button onclick="editMachine('${machine.id}')" class="edit-button"><i data-lucide="edit-2" class="w-4 h-4"></i> Editar</button>
                        <button onclick="deleteMachine('${machine.id}', '${machine.marca} ${machine.modelo}')" class="delete-button"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button>
                    </div>
                `;
                machineListDiv.appendChild(card);
            });
            lucide.createIcons(); // Render new icons
        }

        // --- FORM LOGIC: MOLDS ---
        async function saveMold(event) {
            event.preventDefault();
            showLoading(true);

            const id = moldIdInput.value;
            const moldData = {
                modelo_molde: moldModelInput.value.trim(),
                peca_producao: moldProductionPartInput.value.trim(),
                ano_molde: parseInt(moldYearInput.value),
                detalhes_atuais: moldDetailsInput.value.trim() || null,
            };

            let error;
            if (id) {
                // Update existing mold
                ({ error } = await sbClient.from('moldes_detalhes').update(moldData).eq('id', id));
            } else {
                // Insert new mold
                ({ error } = await sbClient.from('moldes_detalhes').insert([moldData]));
            }

            if (error) {
                console.error("Erro ao salvar molde:", error);
                showCustomAlert(`Erro ao salvar molde: ${error.message}`, 'error');
            } else {
                showCustomAlert(`Molde ${id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                resetMoldForm();
                await loadMolds();
            }
            showLoading(false);
        }

        function editMold(moldId) {
            const mold = molds.find(m => m.id === moldId);
            if (!mold) return;

            moldIdInput.value = mold.id;
            moldModelInput.value = mold.modelo_molde;
            moldProductionPartInput.value = mold.peca_producao;
            moldYearInput.value = mold.ano_molde;
            moldDetailsInput.value = mold.detalhes_atuais || '';

            saveMoldBtn.textContent = 'Atualizar Molde';
            saveMoldBtn.querySelector('i').setAttribute('data-lucide', 'save');
            cancelMoldEditBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top for editing
            lucide.createIcons(); // Re-render lucide icons if changed
        }

        async function deleteMold(moldId, moldName) {
            if (!confirm(`Tem certeza que deseja excluir o molde "${moldName}"? Esta ação não pode ser desfeita.`)) {
                return;
            }
            showLoading(true);
            const { error } = await sbClient.from('moldes_detalhes').delete().eq('id', moldId);
            if (error) {
                console.error("Erro ao excluir molde:", error);
                showCustomAlert(`Erro ao excluir molde: ${error.message}`, 'error');
            } else {
                showCustomAlert('Molde excluído com sucesso!', 'success');
                await loadMolds();
            }
            showLoading(false);
        }

        function resetMoldForm() {
            moldForm.reset();
            moldIdInput.value = '';
            saveMoldBtn.innerHTML = '<i data-lucide="save" class="mr-2 w-5 h-5"></i> Salvar Molde';
            cancelMoldEditBtn.classList.add('hidden');
            lucide.createIcons(); // Re-render lucide icons if changed
        }

        async function loadMolds() {
            showLoading(true);
            const { data, error } = await sbClient.from('moldes_detalhes').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error("Erro ao carregar moldes:", error);
                showCustomAlert(`Erro ao carregar moldes: ${error.message}`, 'error');
                moldListDiv.innerHTML = '<p class="text-red-500 text-center col-span-full">Erro ao carregar moldes.</p>';
                molds = [];
            } else {
                molds = data || [];
                renderMoldList();
            }
            showLoading(false);
        }

        function renderMoldList() {
            moldListDiv.innerHTML = '';
            if (molds.length === 0) {
                moldListDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Nenhum molde cadastrado ainda.</p>';
                return;
            }
            molds.forEach(mold => {
                const card = document.createElement('div');
                card.className = 'record-card';
                card.innerHTML = `
                    <h3>${mold.modelo_molde}</h3>
                    <p><strong>Peça:</strong> ${mold.peca_producao}</p>
                    <p><strong>Ano:</strong> ${mold.ano_molde}</p>
                    ${mold.detalhes_atuais ? `<p><strong>Detalhes:</strong> ${mold.detalhes_atuais}</p>` : ''}
                    <div class="actions">
                        <button onclick="editMold('${mold.id}')" class="edit-button"><i data-lucide="edit-2" class="w-4 h-4"></i> Editar</button>
                        <button onclick="deleteMold('${mold.id}', '${mold.modelo_molde}')" class="delete-button"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button>
                    </div>
                `;
                moldListDiv.appendChild(card);
            });
            lucide.createIcons(); // Render new icons
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupAppLayout(); // Initialize sidebar and settings modal
            await loadMachines();
            await loadMolds();
            lucide.createIcons(); // Initialize all Lucide icons on page load

            navMachineBtn.addEventListener('click', () => {
                machineSection.classList.remove('hidden');
                moldSection.classList.add('hidden');
                navMachineBtn.classList.remove('btn-secondary');
                navMachineBtn.classList.add('btn-primary');
                navMoldBtn.classList.remove('btn-primary');
                navMoldBtn.classList.add('btn-secondary');
            });

            navMoldBtn.addEventListener('click', () => {
                machineSection.classList.add('hidden');
                moldSection.classList.remove('hidden');
                navMoldBtn.classList.remove('btn-secondary');
                navMoldBtn.classList.add('btn-primary');
                navMachineBtn.classList.remove('btn-primary');
                navMachineBtn.classList.add('btn-secondary');
            });

            machineForm.addEventListener('submit', saveMachine);
            cancelMachineEditBtn.addEventListener('click', resetMachineForm);

            moldForm.addEventListener('submit', saveMold);
            cancelMoldEditBtn.addEventListener('click', resetMoldForm);
        });

        // Add this to your existing index.html navigation within the <ul> tag in the <nav> element
        /*
        <li>
            <a href="cadastro-detalhado.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Cadastro Máquinas/Moldes">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8H4a2 2 0 01-2-2v-4A2 2 0 014 12h2m-2 4h4m5-4h5a2 2 0 012 2v4a2 2 0 01-2 2h-5m-2-4H9m2 2h2"></path></svg>
                <span class="ml-4 nav-text">Cadastro Máquinas/Moldes</span>
            </a>
        </li>
        */
    </script>
</body>
</html>


