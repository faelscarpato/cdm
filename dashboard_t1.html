<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Análise - 1º Turno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --sidebar-width: 250px; --sidebar-width-collapsed: 80px; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .main-content { transition: margin-left 0.3s ease; margin-left: var(--sidebar-width-collapsed); }
          .sidebar { width: var(--sidebar-width); transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .long-title { display: none; }
        @media (max-width: 768px) {
            .main-content { margin-left: 0; }
            .sidebar { transform: translateX(-100%); width: var(--sidebar-width); }
            .sidebar.show { transform: translateX(0); }
            .sidebar.show .nav-text, .sidebar.show .long-title { display: inline; }
            .sidebar.collapsed { width: var(--sidebar-width); } /* Garante que em mobile não fique colapsado */
        }
        .action-button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #4f46e5; color: white; } .btn-primary:hover { background-color: #4338ca; }
        .btn-gemini { background: linear-gradient(to right, #4f46e5, #9333ea); color: white; } .btn-gemini:hover { background: linear-gradient(to right, #4338ca, #7e22ce); }
        .btn-export-pdf { background-color: #ef4444; color: white; } .btn-export-pdf:hover { background-color: #dc2626; }
        .btn-export-txt { background-color: #06b6d4; color: white; } .btn-export-txt:hover { background-color: #0891b2; }
        .btn-secondary { background-color: #6b7280; color: white; } .btn-secondary:hover { background-color: #4b5563; }
        .btn-red { background-color: #ef4444; color: white; } .btn-red:hover { background-color: #dc2626; }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .filter-button.active { background-color: #4f46e5; color: white; }
        .filter-button { background-color: #e5e7eb; color: #374151; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .modal-close-button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        .modal-close-button:hover { color: #4b5563; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 1.5rem 2rem; border-radius: 0.5rem; width: 90%; max-width: 800px; }
        #loadingOverlay { display: none; position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; }
        #loadingSpinner { position: absolute; left: 50%; top: 50%; border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-200">
    <div id="loadingOverlay" class="flex items-center justify-center"><div id="loadingSpinner"></div></div>

       <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-white h-screen fixed top-0 left-0 z-40 flex flex-col collapsed">
        <div class="p-4 flex items-center justify-between h-16 border-b border-gray-700">
            <h1 class="text-2xl font-bold whitespace-nowrap overflow-hidden">
                <span class="long-title">CDM - MB</span>
            </h1>
            <button id="close-sidebar" class="text-gray-400 hover:text-white md:hidden text-3xl leading-none">&times;</button>
        </div>
        <nav class="flex-grow p-2 overflow-y-auto">
            <ul>
                <li>
                    <a href="index_geral.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Página Inicial">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-7-7v10a1 1 0 01-1 1H6a1 1 0 01-1-1v-10"></path></svg>
                        <span class="ml-4 nav-text">Página Inicial</span>
                    </a>
                </li>
                <li>
                    <a href="absenteismo.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Absenteísmo">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.225-1.26-.623-1.741M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 0c-2.21 0-4 2.24-4 5v2h8v-2c0-2.76-1.79-5-4-5z"></path></svg>
                        <span class="ml-4 nav-text">Absenteísmo</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="status_t1.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 1ºT</span>
                    </a>
                </li>
                 <li>
                    <a href="status.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 2ºT</span>
                    </a>
                </li>
                 <li>
                    <a href="status_t3.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Status Máquinas">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span class="ml-4 nav-text">Status 3ºT</span>
                    </a>
                </li>
                <li>
                    <a href="cadastro-detalhado.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Cadastro Máquinas/Moldes">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8H4a2 2 0 01-2-2v-4A2 2 0 014 12h2m-2 4h4m5-4h5a2 2 0 012 2v4a2 2 0 01-2 2h-5m-2-4H9m2 2h2"></path></svg>
                        <span class="ml-4 nav-text">Cadastro Detalhado</span>
                    </a>
                </li>
                <li>
                    <a href="analise_causa_raiz.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Análise de Causa Raiz">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span class="ml-4 nav-text">Análise de Causa Raiz</span>
                    </a>
                </li>
                <li>
                    <a href="ordens_servico.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Ordens de Serviço">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        <span class="ml-4 nav-text">Ordens de Serviço</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_qualidade.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Qualidade">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Qualidade</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard_qualidade.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard de Qualidade">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard de Qualidade</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_manutencao.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Manutenção">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Manutenção</span>
                    </a>
                </li>
                <li>
                    <a href="gestao_estoque.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Gestão de Estoque">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <span class="ml-4 nav-text">Gestão de Estoque</span>
                    </a>
                </li>
                <li>
                    <a href="dashboard_geral_consolidado.html" class="flex items-center p-3 my-1 rounded-lg hover:bg-gray-700" title="Dashboard Geral Consolidado">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v8m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="ml-4 nav-text">Dashboard Geral</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-2 border-t border-gray-700">
            <a href="#" id="settings-button" class="flex items-center p-3 rounded-lg hover:bg-gray-700" title="Configurações">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="ml-4 nav-text">Configurações</span>
            </a>
        </div>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <div class="main-content">
        <header class="bg-white shadow-md sticky top-0 z-20 h-16 flex items-center px-6">
            <button id="menu-button" class="p-2 text-gray-500 rounded-md -ml-2 mr-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            <h1 class="text-xl font-semibold text-gray-800">Dashboard de Análise</h1>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Análise de Gargalos e Eficiência - 1º TURNO</h1>
            <div class="card mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Filtrar Período de Análise</h2>
                <div class="flex flex-wrap items-center gap-4">
                    <div id="quick-filters" class="flex flex-wrap gap-2">
                        <button class="action-button filter-button" data-period="today">Hoje</button>
                        <button class="action-button filter-button" data-period="week">Esta Semana</button>
                        <button class="action-button filter-button" data-period="month">Este Mês</button>
                        <button class="action-button filter-button" data-period="semester">Este Semestre</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="startDate" class="form-input p-2 border rounded-md">
                        <span class="text-gray-600">até</span>
                        <input type="date" id="endDate" class="form-input p-2 border rounded-md">
                    </div>
                    <button id="apply-filter" class="action-button btn-primary">Aplicar Filtro</button>
                    <button id="analyze-with-ai" class="action-button btn-gemini" disabled>✨ Analisar Relatório Geral com IA</button>
                </div>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card lg:col-span-2">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Desvio Médio de Ciclo por Máquina</h3>
                    <p class="text-sm text-gray-500 mb-4">Valores positivos indicam lentidão. <strong class="text-indigo-600">Clique em uma barra para análise de causa raiz.</strong></p>
                    <canvas id="gargalosChart"></canvas>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Frequência de Registros por Máquina</h3>
                    <canvas id="frequenciaChart" style="max-height: 350px;"></canvas>
                </div>
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Tendência de Eficiência Diária</h3>
                    <p class="text-sm text-gray-500 mb-4">Média de desvio de ciclo de todas as máquinas ao longo do tempo.</p>
                    <canvas id="tendenciaChart"></canvas>
                </div>
            </div>

            <div class="card mt-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Exportar Relatório do Dashboard</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="export-pdf" class="action-button btn-export-pdf" disabled>Exportar para PDF</button>
                    <button id="export-txt" class="action-button btn-export-txt" disabled>Exportar para TXT</button>
                </div>
            </div>
        </main>

        <!-- GENERAL AI ANALYSIS MODAL -->
        <div id="modal-ai" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">✨ Análise Geral e Sugestões da IA</h2>
                    <button class="modal-close-button" data-close-modal-id="modal-ai">&times;</button>
                </div>
                <div id="ai-result-content" class="prose max-w-none max-h-[60vh] overflow-y-auto text-gray-700"></div>
                <div id="ai-export-buttons" class="mt-4 pt-4 border-t flex justify-end gap-3 hidden">
                    <button onclick="exportarAnaliseTXT('general')" class="action-button btn-export-txt">Exportar TXT</button>
                    <button onclick="exportarAnalisePDF('general')" class="action-button btn-export-pdf">Exportar PDF</button>
                </div>
            </div>
        </div>

        <!-- ROOT CAUSE ANALYSIS (RCA) MODAL -->
        <div id="modal-rca" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="rca-modal-title" class="modal-title">✨ Análise de Causa Raiz</h2>
                    <button class="modal-close-button" data-close-modal-id="modal-rca">&times;</button>
                </div>
                <div id="rca-result-content" class="prose max-w-none max-h-[60vh] overflow-y-auto text-gray-700"></div>
                <div id="rca-export-buttons" class="mt-4 pt-4 border-t flex justify-end gap-3 hidden">
                    <button onclick="exportarAnaliseTXT('rca')" class="action-button btn-secondary">Exportar TXT</button>
                    <button onclick="exportarAnalisePDF('rca')" class="action-button btn-red">Exportar PDF</button>
                </div>
            </div>
        </div>
        
        <!-- SETTINGS MODAL -->
        <div id="modal-settings" class="modal-overlay">
            <div class="modal-content max-w-lg">
                <div class="modal-header">
                    <h2 class="modal-title">Configurações</h2>
                    <button class="modal-close-button" data-close-modal-id="modal-settings">&times;</button>
                </div>
                <div>
                    <label for="gemini-api-key" class="block text-sm font-medium text-gray-700 mb-1">Sua Chave API Google Gemini</label>
                    <input type="password" id="gemini-api-key" class="w-full p-2 border rounded-md mb-2" placeholder="Cole sua chave aqui">
                    <button id="save-api-key" class="action-button btn-primary w-full mb-4">Salvar Chave</button>
                    <div class="text-center">
                        <button id="show-tutorial" class="text-indigo-600 hover:underline text-sm">Como Obter Chave API?</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TUTORIAL MODAL -->
        <div id="modal-tutorial" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Como Obter sua Chave API do Google Gemini</h2>
                    <button class="modal-close-button" data-close-modal-id="modal-tutorial">&times;</button>
                </div>
                <div class="prose max-w-none text-gray-700">
                    <p>Para utilizar todas as funcionalidades de análise por IA, você precisará de uma Chave API do Google Gemini. O Gemini 1.5 Flash, que é necessária, oferece um nível gratuito generoso.</p>
                    <h4>Passo 1: Acesse o Google AI Studio</h4>
                    <p>Se você ainda não tem uma conta Google, precisará criar uma. Depois, acesse o Google AI Studio:</p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="action-button btn-primary">Ir para o Google AI Studio &rarr;</a>
                    <h4 class="mt-4">Passo 2: Gere sua Chave API</h4>
                    <ul>
                        <li>Procure pela opção "Get API key" ou "Criar chave API".</li>
                        <li>Clique em "Create API key in new project".</li>
                        <li>Siga as instruções para nomear seu projeto, se necessário.</li>
                        <li>Após a criação, sua chave API será exibida.</li>
                    </ul>
                    <h4>Passo 3: Copie e Cole sua Chave API</h4>
                    <ul>
                        <li>Clique no botão para copiar sua chave API.</li>
                        <li>Volte para esta página (dentro do modal de Configurações).</li>
                        <li>Cole a chave no campo "Sua Chave API Google Gemini".</li>
                        <li>Clique em "Salvar".</li>
                    </ul>
                    <p class="font-semibold mt-4">Importante: Guarde sua chave API em um local seguro e não a compartilhe publicamente.</p>
                </div>
                <div class="mt-6 text-center">
                    <button class="action-button btn-secondary" data-close-modal-id="modal-tutorial">Entendi - Fechar Tutorial</button>
                </div>
            </div>
        </div>
    </div>

  <script>
        const SUPABASE_URL = 'https://ranhhacbgyfpzrjdynnd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhbmhoYWNiZ3lmcHpyamR5bm5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5MDU4OTEsImV4cCI6MjA1OTQ4MTg5MX0.Ey-X4Tz8krKHSICnYdHdBaI3q5WcRgUVwA8jOhfMr7Y';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const STATUS_TABLE = 'status_maquinas_t1';
        const PARADAS_TABLE = 'paradas_t1';

        let gargalosChartInstance, frequenciaChartInstance, tendenciaChartInstance;
        let processedDataCache = null;
        let allRecordsCache = [];
        const analyzeWithAiBtn = document.getElementById('analyze-with-ai');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        const showLoading = (isLoading) => { document.getElementById('loadingOverlay').style.display = isLoading ? 'flex' : 'none'; };

        async function fetchAndProcessData(startDate, endDate) {
            showLoading(true);
            try {
                const statusPromise = supabaseClient.from(STATUS_TABLE).select('*').gte('data', startDate).lte('data', endDate);
                const paradasPromise = supabaseClient.from(PARADAS_TABLE).select('*').gte('inicio_parada', `${startDate}T00:00:00`).lte('inicio_parada', `${endDate}T23:59:59`);
                
                const [{data: statusData, error: statusError}, {data: paradasData, error: paradasError}] = await Promise.all([statusPromise, paradasPromise]);
                
                if (statusError || paradasError) {
                    console.error("Erro:", statusError || paradasError);
                    return;
                }

                allRecordsCache = statusData;
                const dataByMachine = {};
                statusData.forEach(item => {
                    const machine = item.nome_maquina;
                    if (!dataByMachine[machine]) { dataByMachine[machine] = { totalDeviation: 0, count: 0 }; }
                    const deviation = parseFloat(item.ciclo_atual) - (parseFloat(item.ciclo_padrao) * parseInt(item.n_cavidades || 1));
                    dataByMachine[machine].totalDeviation += deviation;
                    dataByMachine[machine].count++;
                });
                for (const machine in dataByMachine) {
                    dataByMachine[machine].avgDeviation = dataByMachine[machine].count > 0 ? dataByMachine[machine].totalDeviation / dataByMachine[machine].count : 0;
                }
                
                processedDataCache = { byMachine: dataByMachine, paradas: paradasData, status: statusData };
                analyzeWithAiBtn.disabled = false;
                
                renderAllCharts(processedDataCache);
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
            } finally {
                showLoading(false);
            }
        }

        function renderAllCharts(data) {
            renderGargalosChart(data.byMachine);
            renderFrequenciaChart(data.status);
            renderTendenciaChart(data.status);
            renderParadasReport(data.paradas);
        }

        function renderGargalosChart(data) {
            if (gargalosChartInstance) gargalosChartInstance.destroy();
            const ctx = document.getElementById('gargalosChart').getContext('2d');
            const labels = Object.keys(data);
            const chartData = labels.map(label => data[label].avgDeviation);
            const backgroundColors = chartData.map(value => value > 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(34, 197, 94, 0.6)');

            gargalosChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Desvio Médio de Ciclo (s)', data: chartData, backgroundColor: backgroundColors }] },
                options: { 
                    plugins: { title: { display: true, text: 'Desvio Médio de Ciclo por Máquina' } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const machineName = gargalosChartInstance.data.labels[elements[0].index];
                            analisarCausaRaiz(machineName);
                        }
                    }
                }
            });
        }

        function renderFrequenciaChart(statusData) {
            if (frequenciaChartInstance) frequenciaChartInstance.destroy();
            const ctx = document.getElementById('frequenciaChart').getContext('2d');
            const machineCounts = statusData.reduce((acc, item) => {
                acc[item.nome_maquina] = (acc[item.nome_maquina] || 0) + 1;
                return acc;
            }, {});
            frequenciaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(machineCounts),
                    datasets: [{ label: 'Nº de Registros', data: Object.values(machineCounts) }]
                },
                 options: { plugins: { title: { display: true, text: 'Frequência de Registros por Máquina' } } }
            });
        }

        function renderTendenciaChart(statusData) {
            if (tendenciaChartInstance) tendenciaChartInstance.destroy();
            const ctx = document.getElementById('tendenciaChart').getContext('2d');
            const dailyDeviation = statusData.reduce((acc, item) => {
                const date = item.data;
                const deviation = parseFloat(item.ciclo_atual) - (parseFloat(item.ciclo_padrao) * parseInt(item.n_cavidades || 1));
                if (!acc[date]) acc[date] = { totalDeviation: 0, count: 0 };
                acc[date].totalDeviation += deviation;
                acc[date].count++;
                return acc;
            }, {});
            const trendData = Object.keys(dailyDeviation).map(date => ({
                x: date,
                y: dailyDeviation[date].totalDeviation / dailyDeviation[date].count
            }));

            tendenciaChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Desvio Médio Diário (s)', data: trendData, borderColor: 'rgb(75, 192, 192)' }] },
                options: { scales: { x: { type: 'time', time: { unit: 'day' } } }, plugins: { title: { display: true, text: 'Tendência de Eficiência Diária' } } }
            });
        }

        function renderParadasReport(paradas) {
            // Skip paradas report for this dashboard since the HTML element doesn't exist
            console.log('Paradas data:', paradas?.length || 0, 'records');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar logic
            const menuButton = document.getElementById('menu-button');
            const sidebar = document.getElementById('sidebar');
            const closeSidebarButton = document.getElementById('close-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            menuButton.addEventListener('click', () => {
                if (window.innerWidth < 768) { sidebar.classList.add('show'); sidebarOverlay.classList.remove('hidden'); } 
                else { sidebar.classList.toggle('collapsed'); }
            });
            closeSidebarButton.addEventListener('click', () => { sidebar.classList.remove('show'); sidebarOverlay.classList.add('hidden'); });
            sidebarOverlay.addEventListener('click', () => { sidebar.classList.remove('show'); sidebarOverlay.classList.add('hidden'); });
            
            // Filter logic
            document.getElementById('apply-filter').addEventListener('click', () => {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if(startDate && endDate) fetchAndProcessData(startDate, endDate);
            });

            // Quick filters
            document.getElementById('quick-filters').addEventListener('click', (e) => {
                if (e.target.matches('button[data-period]')) {
                    const period = e.target.dataset.period;
                    const today = new Date();
                    let start = new Date();
                    let end = new Date();

                    switch (period) {
                        case 'today': break;
                        case 'week':
                            const dayOfWeek = today.getDay();
                            start.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                            break;
                        case 'month':
                            start = new Date(today.getFullYear(), today.getMonth(), 1);
                            break;
                        case 'semester':
                            const currentMonth = today.getMonth();
                            start = new Date(today.getFullYear(), currentMonth < 6 ? 0 : 6, 1);
                            break;
                    }

                    document.getElementById('startDate').value = start.toISOString().split('T')[0];
                    document.getElementById('endDate').value = end.toISOString().split('T')[0];
                    document.getElementById('apply-filter').click();

                    document.getElementById('quick-filters').querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });

            // Modal closing
            document.body.addEventListener('click', (e) => {
                if (e.target.dataset.closeModalId) {
                    document.getElementById(e.target.dataset.closeModalId).classList.remove('show');
                }
            });

            // --- AI ANALYSIS ---
            analyzeWithAiBtn.addEventListener('click', async () => {
                if (!processedDataCache) { alert("Não há dados processados para analisar."); return; }
                document.getElementById('modal-ai').classList.add('show');
                const aiContent = document.getElementById('ai-result-content');
                const aiExportButtons = document.getElementById('ai-export-buttons');
                let dataSummary = "Resumo dos dados por máquina (1º turno):\n" + Object.entries(processedDataCache.byMachine).map(([m,d]) => `- Máquina: ${m}, Desvio Médio: ${d.avgDeviation.toFixed(2)}s, Nº Registros: ${d.count}`).join('\n');
                const prompt = `Como analista de produção sênior, analise o seguinte relatório do 1º turno de ${startDateInput.value} a ${endDateInput.value}. Dados: ${dataSummary}. Forneça um resumo executivo, identifique os principais gargalos (piores máquinas), analise tendências de eficiência e sugira um plano de ação claro, forneça uma lista completa de todas as máquinas, detalhe suas observações. Formate com títulos em negrito e listas.`;
                await callGeminiApi(prompt, aiContent, aiExportButtons);
            });

            async function analisarCausaRaiz(machineName) {
                document.getElementById('modal-rca').classList.add('show');
                const rcaContent = document.getElementById('rca-result-content');
                const rcaExportButtons = document.getElementById('rca-export-buttons');
                document.getElementById('rca-modal-title').innerText = `✨ Análise de Causa Raiz: ${machineName}`;
                const machineRecords = allRecordsCache.filter(r => r.nome_maquina === machineName).map(r => `- Data: ${r.data}, Turno: 1º, Ciclo Padrão: ${r.ciclo_padrao}s, Atual: ${r.ciclo_atual}s, Obs: ${r.observacoes || 'N/A'}`).join('\n');
                const prompt = `Como especialista em injetoras, faça uma Análise de Causa Raiz para a máquina **${machineName}**, considerando dados do 1º turno de ${startDateInput.value} a ${endDateInput.value}. Registros: ${machineRecords}. Forneça em português: 1. **Diagnóstico Principal**. 2. **Evidências do Turno**. 3. **Ações Corretivas Imediatas**. 4. **Ações Preventivas**. Seja técnico e direto, Formate com títulos em negritos e listas.`;
                await callGeminiApi(prompt, rcaContent, rcaExportButtons);
            }

            async function callGeminiApi(prompt, contentElement, exportButtonsElement) {
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) {
                    alert('Chave API do Gemini não encontrada. Por favor, salve sua chave nas Configurações.');
                    contentElement.innerHTML = '<p class="text-red-500">Chave API não configurada.</p>';
                    return;
                }
                showLoading(true);
                contentElement.innerHTML = '<p>Analisando dados com a IA... Por favor, aguarde.</p>';
                exportButtonsElement.classList.add('hidden');
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        let htmlResult = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^- (.*$)/gm, '<li class="ml-4 list-disc">$1</li>').replace(/\n/g, '<br>');
                        contentElement.innerHTML = htmlResult;
                        exportButtonsElement.classList.remove('hidden');
                    } else { throw new Error("Resposta da API inválida."); }
                } catch (error) {
                    console.error('Erro na chamada da API Gemini:', error);
                    contentElement.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar a análise da IA. (Erro: ${error.message})</p>`;
                } finally {
                    showLoading(false);
                }
            }

            function exportarAnaliseTXT(type) {
                const isRCA = type === 'rca';
                const contentElement = document.getElementById(isRCA ? 'rca-result-content' : 'ai-result-content');
                const title = isRCA ? document.getElementById('rca-modal-title').innerText : 'Relatório de Análise Geral (1º Turno)';
                const contentText = contentElement.innerText;
                if (!contentText || contentText.trim().startsWith('Analisando dados')) {
                    alert("Não há análise para exportar ou a análise está em andamento.");
                    return;
                }
                const formatDateForFile = (date) => new Date(date).toISOString().split('T')[0];
                let fileContent = `${title.toUpperCase()}\nPeríodo: ${startDateInput.value} a ${endDateInput.value}\n\n=========================================\n\n${contentText}`;
                const blob = new Blob([fileContent], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `analise-${type}-1T-${formatDateForFile(new Date())}.txt`;
                link.click();
                URL.revokeObjectURL(url);
            }

            function exportarAnalisePDF(type) {
                const isRCA = type === 'rca';
                const contentElement = document.getElementById(isRCA ? 'rca-result-content' : 'ai-result-content');
                let title = isRCA ? document.getElementById('rca-modal-title').innerText : "Relatório de Análise Geral (1º Turno)";
                const contentText = contentElement.innerText;
                if (!contentText || contentText.trim().startsWith('Analisando dados')) {
                    alert("Não há análise para exportar ou a análise está em andamento.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const formatDateForFile = (date) => new Date(date).toISOString().split('T')[0];
                doc.setFontSize(16);
                doc.text(title, 14, 22);
                doc.setFontSize(11);
                doc.text(`Período da Análise: ${startDateInput.value} a ${endDateInput.value}`, 14, 30);
                doc.setLineWidth(0.5); doc.line(14, 32, 196, 32);
                doc.setFontSize(10);
                const lines = doc.splitTextToSize(contentText, 180);
                doc.text(lines, 14, 42);
                doc.save(`analise-${type}-1T-${formatDateForFile(new Date())}.pdf`);
            }


            document.getElementById('settings-button').addEventListener('click', () => {
                document.getElementById('modal-settings').classList.add('show');
            });

            document.getElementById('show-tutorial').addEventListener('click', () => {
                document.getElementById('modal-tutorial').classList.add('show');
            });

            document.getElementById('save-api-key').addEventListener('click', () => {
                const apiKey = document.getElementById('gemini-api-key').value;
                if (apiKey) {
                    localStorage.setItem('gemini-api-key', apiKey);
                    alert('Chave API salva com sucesso!');
                    document.getElementById('modal-settings').classList.remove('show');
                } else {
                    alert('Por favor, insira uma chave API válida.');
                }
            });

            const savedApiKey = localStorage.getItem('gemini-api-key');
            if (savedApiKey) {
                document.getElementById('gemini-api-key').value = savedApiKey;
            }

            const weekBtn = document.getElementById('quick-filters').querySelector('[data-period="week"]');
            if (weekBtn) weekBtn.click();
        });
    </script>
    </body>
</html>
